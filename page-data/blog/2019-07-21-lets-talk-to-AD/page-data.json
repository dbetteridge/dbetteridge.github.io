{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2019-07-21-lets-talk-to-AD/","webpackCompilationHash":"452c085e19083fa4f4eb","result":{"data":{"markdownRemark":{"id":"a3cd6fa0-d904-5d11-939f-fc6bb1ff73d9","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 96px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa0b4d3aef91335419c7f295c9ac6f83/31c9d/System.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 316.6666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAA/ABQDASIAAhEBAxEB/8QAGQAAAwEBAQAAAAAAAAAAAAAAAAECAwQF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB9paIk0BznB0iAm5KAMWZjNA//8QAHRAAAgIDAAMAAAAAAAAAAAAAAAEREgIQIRMiMf/aAAgBAQABBQJuCyHlB09hKNTrI6L5EixW09SWPJUySFRlUz//xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAEDAQE/AQ//xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAECAQE/AQ//xAAgEAACAQQBBQAAAAAAAAAAAAAAASECESIyIDAxQWGR/9oACAEBAAY/ApTZq/hYg8Lj3dyXUl76GsmjJRKujGkyln//xAAgEAEAAgEFAAMBAAAAAAAAAAABABExECFBUXFhkaHx/9oACAEBAAE/IRo2HRctrki3a2UMjxm7+kARQzAee6WuwOhzCztDoTHcRkXA71v86LWYDh0vlTwink+onYh7OhH5LWZJmAh//9oADAMBAAIAAwAAABDDBzDzwDz/xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAEDAQE/EA//xAAUEQEAAAAAAAAAAAAAAAAAAAAw/9oACAECAQE/EA//xAAhEAEAAQQBBAMAAAAAAAAAAAABEQAhMWFBEFFxkYGhwf/aAAgBAQABPxCToMyoNaqJDlWZHn1QuEGEpZMTsW+Kt8XclflRglVlXK1nUTjdYzKW0En30FoR4WHzTfKEqAdU1QJOJzHH1RUENlKEKGylj30ASgN0fAr2noXrGIkv4vx+1ETbTp90xOshlFCBMlnkbKIAdaI91eMGWLGiv//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"System\"\n        title=\"System\"\n        src=\"/static/fa0b4d3aef91335419c7f295c9ac6f83/31c9d/System.jpg\"\n        srcset=\"/static/fa0b4d3aef91335419c7f295c9ac6f83/31c9d/System.jpg 96w\"\n        sizes=\"(max-width: 96px) 100vw, 96px\"\n      />\n  </a>\n    </span></p>\n<h2>The project at hand</h2>\n<p>We need to be able to do a list of operations that talk to active directory.</p>\n<ul>\n<li>List groups found active directory</li>\n<li>List users from a given group</li>\n<li>Quickly check if a user is a group member</li>\n</ul>\n<h2>The how</h2>\n<p>For this process we're going to talk to the Microsoft graph, for the purposes of this post everything is already setup so that groups and users can be found within it.</p>\n<ol>\n<li>\n<p>Obtain a bearer token</p>\n<pre><code class=\"language-javascript\">const rootLogin = `https://login.microsoftonline.com/arup.onmicrosoft.com/oauth2/v2.0/token`\n\nconst params = {\n  grant_type: 'client_credentials',\n  client_id:\n    process.env['waad_client_id'] || '',\n  client_secret:\n    process.env['waad_client_secret'] ||\n    '',\n  scope: 'https://graph.microsoft.com/.default',\n}\n\nconst encodedUrlParams = Object.keys(params)\n  .map(key => key + '=' + params[key])\n  .join('&#x26;')\n\nconst content_type = 'application/x-www-form-urlencoded'\nconst getAccessToken = async () => {\n  return fetch(rootLogin, {\n    headers: { 'Content-Type': content_type },\n    method: 'POST',\n    body: encodedUrlParams,\n  })\n    .then(body => body.json())\n    .then(json =>\n      json\n        ? `${json.token_type} ${json.access_token}`\n        : new Error('Failed to retrieve token')\n    )\n    .catch(console.log)\n}\n</code></pre>\n<p>We need to talk to the oauth api and hand over our <code>client_id</code> and <code>client_secret</code>, in return we get a time limited Bearer token to request data.</p>\n</li>\n<li>\n<p>Get a list of groups</p>\n<pre><code class=\"language-javascript\">export const getADGroups = async name => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n  const groupResults = await fetch(\n    `https://graph.microsoft.com/v1.0/groups?$top=10&#x26;$filter=startsWith(displayName, '${name}')&#x26;$select=id,displayName&#x26;$format=json`,\n    {\n      method: 'GET',\n      headers: { Authorization: access_token },\n    }\n  )\n    .then(body => body.json())\n    .catch(console.log)\n  const groups = groupResults &#x26;&#x26; groupResults.value\n  return groups\n}\n</code></pre>\n<p>For our use case we are searching by the start of the group name, and restricting our search to the top 10 results.</p>\n</li>\n<li>\n<p>Pagination!</p>\n<pre><code class=\"language-javascript\">const getAllPages = async (pages, pageResults) => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n  // Store results into pages\n  // If nextLink call getADpages with new link\n  // Repeat till nextLink doesnt exist then return\n  pages = pages.concat(pageResults.value)\n  if (pageResults &#x26;&#x26; typeof pageResults['@odata.nextLink'] === 'string') {\n    const page_results = await fetch(pageResults['@odata.nextLink'], {\n      method: 'GET',\n      headers: { Authorization: access_token },\n    }).then(body => body.json())\n\n    pages = getAllPages(pages, page_results)\n  }\n  return pages\n}\n\nconst getNPages = async (pages, pageResults, n) => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n  // Store results into pages\n  // If nextLink call getADpages with new link\n  // Repeat till nextLink doesnt exist then return\n  pages = pages.concat(pageResults.value)\n  if (n > 0) {\n    if (pageResults &#x26;&#x26; typeof pageResults['@odata.nextLink'] === 'string') {\n      const page_results = await fetch(pageResults['@odata.nextLink'], {\n        method: 'GET',\n        headers: { Authorization: access_token },\n      })\n        .then(body => body.json())\n        .catch(err => console.log(err))\n      pages = getNPages(pages, page_results, n - 1)\n    }\n  }\n  return pages\n}\n</code></pre>\n<p>  We need some helper functions to paginate through the returned results when the number of members > 100\nthe graph api will return a property <code>@odata.nextLink</code> which contains a url to retrieve the next batch.</p>\n<p>  We have two helper functions, the first will keep going till the property is no longer present (very slow, many http requests)\nThe second takes a <code>n</code> parameter describing the level of recursion it should go to, this avoids it getting stuck in an infinite recursion loop (hopefully) and speeds things up.</p>\n</li>\n<li>\n<p>Get group members</p>\n<pre><code class=\"language-javascript\">export const getADGroupMembers = async groupId => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n  const groupResults = await fetch(\n    `https://graph.microsoft.com/v1.0/groups/${groupId}/transitiveMembers?$filter@odata.type eq '#microsoft.graph.user'`,\n    {\n      method: 'GET',\n      headers: { Authorization: access_token },\n    }\n  )\n    .then(body => body.json())\n    .catch(console.log)\n  let members = []\n  members = await getAllPages(members, groupResults)\n  return members\n}\n</code></pre>\n<p>  Grabs all the group members using the first pagination helper function.</p>\n<pre><code class=\"language-javascript\">export const getNPagesADGroupMembers = async (groupId, numPages) => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n  const groupResults = await fetch(\n    `https://graph.microsoft.com/v1.0/groups/${groupId}/transitiveMembers`,\n    {\n      method: 'GET',\n      headers: { Authorization: access_token },\n    }\n  )\n    .then(body => body.json())\n    .catch(console.log)\n  let members = []\n  members = await getNPages(members, groupResults, numPages - 1)\n  members = members.filter(\n    member => member['@odata.type'] === '#microsoft.graph.user'\n  )\n  return members\n}\n</code></pre>\n<p>  Grab the first n pages of the group members using the second pagination helper function.</p>\n</li>\n<li>\n<p>Check group membership for a single user and a list of groups</p>\n<pre><code class=\"language-javascript\">export const checkADGroupMembership = async (ad_groups, email) => {\n  if (!access_token) {\n    access_token = await getAccessToken()\n  }\n\n  const groupResults = await fetch(\n    `https://graph.microsoft.com/v1.0/users/${email}/checkMemberGroups`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: access_token,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ groupIds: ad_groups }),\n    }\n  )\n    .then(body => body.json())\n    .catch(console.log)\n  return groupResults &#x26;&#x26; groupResults.value\n}\n</code></pre>\n<p>Here we pass a list of group id's and a single email address, this uses a built in function\nin Microsoft graph and returns the <code>group_id's</code> the email is a member of.</p>\n</li>\n</ol>\n<h2>Make it fast</h2>\n<p>The microsoft graph API is...slow (understandably), for anything more then a single call we will be waiting\nmultiple seconds, for the cases of pagination where we might be fetching 5+ pages of users from a group\nwhere each call takes 1+ seconds this quickly adds up.</p>\n<p>So what we're going to do is stick redis in front of our calls to the graph with a 3600 second expiry time.\nThis way our most popular calls are not hitting the graph each time, we only pay the penalty once.</p>\n<pre><code>  Pre redis\n  ✓ Searching specific group (3038ms)\n  ✓ Searching specific group - case insensitive (625ms)\n  ✓ Fetching group and its members (2106ms)\n  ✓ Check AD group membership (942ms)\n  ✓ Get N pages of users (3777ms)\n\n  Post redis\n  ✓ Searching specific group (19ms)\n  ✓ Searching specific group - case insensitive (11ms)\n  ✓ Fetching group and its members (6ms)\n  ✓ Check AD group membership (1ms)\n  ✓ Get N pages of users (3ms)\n</code></pre>\n<h2>TADA</h2>\n<p>We've accomplished the tasks we set out to do, a good way to talk to Active Directory without\nneeding to be on premise.</p>\n<p>This allows project managers to setup a single group in active directory and reuse it elsewhere\nno further setup needed.</p>","frontmatter":{"date":"July 21, 2019","title":"Let's talk to Active Directory","description":"When you need to find out info about your users and groups","tags":["node","active directory"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"a3cd6fa0-d904-5d11-939f-fc6bb1ff73d9"}}}